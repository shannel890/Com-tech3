{% extends 'base.html' %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
  #videos-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }
  .video-player {
    background: black;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .video-label {
    position: absolute;
    bottom: 8px;
    left: 8px;
    color: white;
    background: rgba(0, 0, 0, 0.5);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9rem;
  }
</style>

<div data-theme="light" class="flex flex-col h-screen bg-gray-100 font-sans">
  <header class="navbar p-4 bg-base-100 shadow-sm border-b border-base-200">
    <div class="flex-1">
      <h1 class="text-xl font-bold">Group Call: {{ group.name }}</h1>
    </div>
    <div class="flex-none">
      <a href="{{ url_for('dashboard.index') }}" class="btn btn-sm btn-ghost">
        <i class="fas fa-times mr-2"></i> End Call
      </a>
    </div>
  </header>

  <main class="flex-1 p-4 overflow-y-auto">
    <div id="videos-container">
      <div class="video-player">
        <video id="local-video" autoplay muted playsinline></video>
        <div class="video-label">You</div>
      </div>
    </div>
  </main>

  <footer class="p-4 bg-base-100 border-t border-base-200 flex justify-center items-center gap-4">
    <button id="mic-btn" class="btn btn-circle btn-primary">
      <i class="fas fa-microphone"></i>
    </button>
    <button id="video-btn" class="btn btn-circle btn-primary">
      <i class="fas fa-video"></i>
    </button>
    <a href="{{ url_for('dashboard.index') }}" class="btn btn-circle btn-error">
      <i class="fas fa-phone-slash"></i>
    </a>
  </footer>
</div>

<script>
  const socket = io();
  const localVideo = document.getElementById('local-video');
  const videosContainer = document.getElementById('videos-container');
  const micBtn = document.getElementById('mic-btn');
  const videoBtn = document.getElementById('video-btn');

  const groupId = "{{ group.id }}";
  const userId = "{{ current_user.id }}";
  const userName = "{{ current_user.name }}";

  let localStream;
  let peerConnections = {};
  let isAudioMuted = false;
  let isVideoEnabled = true;

  const peerConnectionConfig = {
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  };

  async function startCall() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      socket.emit('join_call', { group_id: groupId });
    } catch (error) {
      console.error('Error accessing media devices.', error);
      alert('Could not access your camera and microphone. Please check permissions.');
    }
  }

  socket.on('user_joined_call', (data) => {
    if (data.user_id !== userId) {
      console.log('User joined call:', data.user_id);
      createPeerConnection(data.user_id, true);
    }
  });

  socket.on('all_users', (data) => {
    console.log('All users in call:', data.users);
    data.users.forEach(user => {
      if (user.id !== userId) {
        createPeerConnection(user.id, false);
      }
    });
  });

  socket.on('offer', async (data) => {
    if (data.target_id === userId) {
      console.log('Received offer from:', data.caller_id);
      const pc = createPeerConnection(data.caller_id, false);
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('answer', {
        group_id: groupId,
        target_id: data.caller_id,
        caller_id: userId,
        answer: pc.localDescription
      });
    }
  });

  socket.on('answer', async (data) => {
    if (data.target_id === userId) {
      console.log('Received answer from:', data.caller_id);
      const pc = peerConnections[data.caller_id];
      if (pc) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
    }
  });

  socket.on('ice_candidate', async (data) => {
    if (data.target_id === userId) {
      const pc = peerConnections[data.caller_id];
      if (pc) {
        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    }
  });

  socket.on('user_left_call', (data) => {
    console.log('User left call:', data.user_id);
    if (peerConnections[data.user_id]) {
      peerConnections[data.user_id].close();
      delete peerConnections[data.user_id];
    }
    const videoElement = document.getElementById(`video-${data.user_id}`);
    if (videoElement) {
      videoElement.parentElement.remove();
    }
  });

  function createPeerConnection(targetUserId, isInitiator) {
    if (peerConnections[targetUserId]) {
      return peerConnections[targetUserId];
    }

    const pc = new RTCPeerConnection(peerConnectionConfig);
    peerConnections[targetUserId] = pc;

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.onicecandidate = (event) => {
      if (event.candidate) {
        socket.emit('ice_candidate', {
          group_id: groupId,
          target_id: targetUserId,
          caller_id: userId,
          candidate: event.candidate,
        });
      }
    };

    pc.ontrack = (event) => {
      let videoElement = document.getElementById(`video-${targetUserId}`);
      if (!videoElement) {
        const videoPlayer = document.createElement('div');
        videoPlayer.className = 'video-player';
        videoElement = document.createElement('video');
        videoElement.id = `video-${targetUserId}`;
        videoElement.autoplay = true;
        videoElement.playsinline = true;
        const videoLabel = document.createElement('div');
        videoLabel.className = 'video-label';
        // We'll need to get the user's name somehow, for now use ID
        videoLabel.textContent = `User ${targetUserId}`;
        videoPlayer.appendChild(videoElement);
        videoPlayer.appendChild(videoLabel);
        videosContainer.appendChild(videoPlayer);
      }
      videoElement.srcObject = event.streams[0];
    };

    if (isInitiator) {
      pc.createOffer()
        .then(offer => pc.setLocalDescription(offer))
        .then(() => {
          socket.emit('offer', {
            group_id: groupId,
            target_id: targetUserId,
            caller_id: userId,
            offer: pc.localDescription,
          });
        })
        .catch(e => console.error(e));
    }

    return pc;
  }

  micBtn.addEventListener('click', () => {
    isAudioMuted = !isAudioMuted;
    localStream.getAudioTracks()[0].enabled = !isAudioMuted;
    micBtn.innerHTML = isAudioMuted
      ? '<i class="fas fa-microphone-slash"></i>'
      : '<i class="fas fa-microphone"></i>';
    micBtn.classList.toggle('btn-primary', !isAudioMuted);
    micBtn.classList.toggle('btn-outline', isAudioMuted);
  });

  videoBtn.addEventListener('click', () => {
    isVideoEnabled = !isVideoEnabled;
    localStream.getVideoTracks()[0].enabled = isVideoEnabled;
    videoBtn.innerHTML = isVideoEnabled
      ? '<i class="fas fa-video"></i>'
      : '<i class="fas fa-video-slash"></i>';
    videoBtn.classList.toggle('btn-primary', isVideoEnabled);
    videoBtn.classList.toggle('btn-outline', !isVideoEnabled);
  });

  window.addEventListener('beforeunload', () => {
    socket.emit('leave_call', { group_id: groupId });
  });

  startCall();
</script>
{% endblock %}